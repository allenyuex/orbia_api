// Code generated by hertz generator.

package main

import (
	"context"
	"fmt"
	"os"
	"os/signal"
	"syscall"

	"github.com/cloudwego/hertz/pkg/app"
	"github.com/cloudwego/hertz/pkg/app/server"
	"github.com/cloudwego/hertz/pkg/protocol/consts"

	"orbia_api/biz/dal/mysql"
	"orbia_api/biz/handler/auth"
	"orbia_api/biz/handler/kol"
	"orbia_api/biz/handler/team"
	"orbia_api/biz/handler/user"
	"orbia_api/biz/infra/config"
	"orbia_api/biz/mw"
	"orbia_api/biz/utils"
)

func main() {
	// åˆå§‹åŒ–æ—¥å¿—å™¨
	utils.InitLogger()
	utils.LogInfo("ğŸš€ Starting Orbia API Server...")

	// 1. åŠ è½½é…ç½®
	configPath := os.Getenv("CONFIG_PATH")
	if configPath == "" {
		configPath = "./conf/config.yaml"
	}
	if err := config.LoadConfig(configPath); err != nil {
		utils.LogError(err, "âŒ Failed to load config")
		os.Exit(1)
	}
	utils.LogInfo("âœ… Config loaded successfully")

	// 2. åˆå§‹åŒ–æ•°æ®åº“
	if err := mysql.Init(); err != nil {
		utils.LogError(err, "âŒ Failed to initialize MySQL")
		os.Exit(1)
	}
	defer mysql.Close()

	// 3. åˆå§‹åŒ–è®¤è¯ä¸­é—´ä»¶ï¼ˆéœ€è¦åœ¨æœåŠ¡ä¹‹å‰åˆå§‹åŒ–ï¼‰
	userRepo := mysql.NewUserRepository(mysql.DB)
	mw.InitAuthMiddleware(userRepo)
	utils.LogInfo("âœ… Auth middleware initialized successfully")

	// 4. åˆå§‹åŒ–æœåŠ¡
	auth.InitAuthService()
	user.InitUserService()
	team.InitTeamService()
	kol.InitKolService()
	utils.LogInfo("âœ… Services initialized successfully")

	// 5. åˆ›å»º Hertz æœåŠ¡å™¨
	addr := fmt.Sprintf("%s:%d",
		config.GlobalConfig.Server.Host,
		config.GlobalConfig.Server.Port,
	)
	h := server.Default(
		server.WithHostPorts(addr),
	)

	// 6. æ³¨å†Œå…¨å±€ä¸­é—´ä»¶
	h.Use(mw.Recovery()) // æ¢å¤ä¸­é—´ä»¶ï¼Œå¿…é¡»æ”¾åœ¨æœ€å‰é¢
	h.Use(mw.CORS())     // è·¨åŸŸä¸­é—´ä»¶
	h.Use(mw.Logger())   // æ—¥å¿—ä¸­é—´ä»¶

	// 7. å¥åº·æ£€æŸ¥
	h.GET("/health", func(ctx context.Context, c *app.RequestContext) {
		c.JSON(consts.StatusOK, map[string]interface{}{
			"status":  "ok",
			"message": "Orbia API is running",
		})
	})

	// 8. æ¬¢è¿é¡µé¢
	h.GET("/", func(ctx context.Context, c *app.RequestContext) {
		c.JSON(consts.StatusOK, map[string]interface{}{
			"message": "Welcome to Orbia API",
			"version": "1.0.0",
			"docs":    "/api/v1/auth/wallet-login",
		})
	})

	// 9. æ³¨å†Œä¸šåŠ¡è·¯ç”±ï¼ˆç”± hz ç”Ÿæˆï¼‰
	register(h)

	// 10. æ‰“å°å¯åŠ¨ä¿¡æ¯
	utils.LogInfo(fmt.Sprintf("âœ¨ Server is running on http://%s", addr))
	utils.LogInfo("ğŸ“š API Endpoints:")
	utils.LogInfo("   GET  /                              - Welcome message")
	utils.LogInfo("   GET  /health                        - Health check")
	utils.LogInfo("   POST /api/v1/auth/wallet-login      - Wallet login")
	utils.LogInfo("   POST /api/v1/auth/email-login       - Email login")
	utils.LogInfo("   POST /api/v1/user/profile           - Get user profile (requires JWT)")
	utils.LogInfo("   POST /api/v1/user/update-profile    - Update user profile (requires JWT)")
	utils.LogInfo("   POST /api/v1/user/:user_id          - Get user by ID")
	utils.LogInfo("")
	utils.LogInfo("ğŸ’¡ Test commands:")
	utils.LogInfo(fmt.Sprintf("   curl http://localhost:%d/health", config.GlobalConfig.Server.Port))
	utils.LogInfo(fmt.Sprintf("   curl -X POST http://localhost:%d/api/v1/auth/wallet-login -H \"Content-Type: application/json\" -d '{\"wallet_address\":\"0x...\",\"signature\":\"0x...\"}'", config.GlobalConfig.Server.Port))
	utils.LogInfo("")

	// 11. ä¼˜é›…å…³é—­
	go handleShutdown()

	// 12. å¯åŠ¨æœåŠ¡å™¨
	h.Spin()
}

func handleShutdown() {
	sigCh := make(chan os.Signal, 1)
	signal.Notify(sigCh, syscall.SIGINT, syscall.SIGTERM)
	<-sigCh
	utils.LogInfo("\nğŸ›‘ Shutting down server...")
	mysql.Close()
	os.Exit(0)
}
