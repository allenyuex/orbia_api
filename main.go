// Code generated by hertz generator.

package main

import (
	"context"
	"fmt"
	"log"
	"os"
	"os/signal"
	"syscall"

	"github.com/cloudwego/hertz/pkg/app"
	"github.com/cloudwego/hertz/pkg/app/server"
	"github.com/cloudwego/hertz/pkg/protocol/consts"

	"orbia_api/biz/dal/mysql"
	"orbia_api/biz/handler/auth"
	"orbia_api/biz/handler/user"
	"orbia_api/biz/infra/config"
	"orbia_api/biz/mw"
)

func main() {
	log.Println("ğŸš€ Starting Orbia API Server...")

	// 1. åŠ è½½é…ç½®
	configPath := os.Getenv("CONFIG_PATH")
	if configPath == "" {
		configPath = "./conf/config.yaml"
	}
	if err := config.LoadConfig(configPath); err != nil {
		log.Fatalf("âŒ Failed to load config: %v", err)
	}
	log.Println("âœ… Config loaded successfully")

	// 2. åˆå§‹åŒ–æ•°æ®åº“
	if err := mysql.Init(); err != nil {
		log.Fatalf("âŒ Failed to initialize MySQL: %v", err)
	}
	defer mysql.Close()

	// 3. åˆå§‹åŒ–æœåŠ¡
	auth.InitAuthService()
	user.InitUserService()
	log.Println("âœ… Services initialized successfully")

	// 4. åˆ›å»º Hertz æœåŠ¡å™¨
	addr := fmt.Sprintf("%s:%d",
		config.GlobalConfig.Server.Host,
		config.GlobalConfig.Server.Port,
	)
	h := server.Default(
		server.WithHostPorts(addr),
	)

	// 5. æ³¨å†Œå…¨å±€ä¸­é—´ä»¶
	h.Use(mw.Recovery()) // æ¢å¤ä¸­é—´ä»¶ï¼Œå¿…é¡»æ”¾åœ¨æœ€å‰é¢
	h.Use(mw.CORS())     // è·¨åŸŸä¸­é—´ä»¶
	h.Use(mw.Logger())   // æ—¥å¿—ä¸­é—´ä»¶

	// 6. å¥åº·æ£€æŸ¥
	h.GET("/health", func(ctx context.Context, c *app.RequestContext) {
		c.JSON(consts.StatusOK, map[string]interface{}{
			"status":  "ok",
			"message": "Orbia API is running",
		})
	})

	// 7. æ¬¢è¿é¡µé¢
	h.GET("/", func(ctx context.Context, c *app.RequestContext) {
		c.JSON(consts.StatusOK, map[string]interface{}{
			"message": "Welcome to Orbia API",
			"version": "1.0.0",
			"docs":    "/api/v1/auth/wallet-login",
		})
	})

	// 8. æ³¨å†Œä¸šåŠ¡è·¯ç”±ï¼ˆç”± hz ç”Ÿæˆï¼‰
	register(h)

	// 9. æ‰“å°å¯åŠ¨ä¿¡æ¯
	log.Printf("âœ¨ Server is running on http://%s", addr)
	log.Println("ğŸ“š API Endpoints:")
	log.Println("   GET  /                              - Welcome message")
	log.Println("   GET  /health                        - Health check")
	log.Println("   POST /api/v1/auth/wallet-login      - Wallet login")
	log.Println("   POST /api/v1/auth/email-login       - Email login")
	log.Println("   POST /api/v1/user/profile           - Get user profile (requires JWT)")
	log.Println("   POST /api/v1/user/update-profile    - Update user profile (requires JWT)")
	log.Println("   POST /api/v1/user/:user_id          - Get user by ID")
	log.Println("")
	log.Println("ğŸ’¡ Test commands:")
	log.Printf("   curl http://localhost:%d/health\n", config.GlobalConfig.Server.Port)
	log.Printf("   curl -X POST http://localhost:%d/api/v1/auth/wallet-login -H \"Content-Type: application/json\" -d '{\"wallet_address\":\"0x...\",\"signature\":\"0x...\"}'\n", config.GlobalConfig.Server.Port)
	log.Println("")

	// 10. ä¼˜é›…å…³é—­
	go handleShutdown()

	// 11. å¯åŠ¨æœåŠ¡å™¨
	h.Spin()
}

func handleShutdown() {
	sigCh := make(chan os.Signal, 1)
	signal.Notify(sigCh, syscall.SIGINT, syscall.SIGTERM)
	<-sigCh
	log.Println("\nğŸ›‘ Shutting down server...")
	mysql.Close()
	os.Exit(0)
}
